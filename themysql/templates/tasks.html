{% extends "layout.html" %}
{% block body %}
<h3>运输任务</h3>

<div class="mb-2">
  {% if not (current_user.role and '司机' in current_user.role) %}
    <a class="btn btn-success" href="{{ url_for('tasks.create_task') }}">新增任务</a>
  {% endif %}
</div>

<table class="table table-sm table-bordered">
  <thead>
    <tr>
      <th>ID</th>
      <th>客户</th>
      <th>需要车型</th>
      <th>需要数量</th>
      <th>计划里程</th>
      <th>计划开始</th>
      <th>计划结束</th>
      <th>安排车辆</th>
      <th>安排司机</th>
      <th>实际开始</th>
      <th>实际结束</th>
      <th>实际里程</th>
      <th>耗油</th>
      <th>状态</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for t in tasks %}
      <tr>
        <td>{{ t.id }}</td>
        <td>{{ t.client_name }}</td>
        <td>{{ t.need_vehicle_type }}</td>
        <td>{{ t.need_count }}</td>
        <td>{{ '%.2f'|format(t.plan_mileage) if t.plan_mileage is not none else '' }}</td>
        <td>{{ t.plan_start_time.strftime('%Y-%m-%d %H:%M:%S') if t.plan_start_time else '' }}</td>
        <td>{{ t.plan_end_time.strftime('%Y-%m-%d %H:%M:%S') if t.plan_end_time else '' }}</td>
        <td>{{ t.vehicle.plate_number if t.vehicle else '' }}</td>
        <td>{{ t.driver.name if t.driver else '' }}</td>
        <td>{{ t.real_start_time.strftime('%Y-%m-%d %H:%M:%S') if t.real_start_time else '' }}</td>
        <td>{{ t.real_end_time.strftime('%Y-%m-%d %H:%M:%S') if t.real_end_time else '' }}</td>
        <td>{{ '%.2f'|format(t.real_mileage) if t.real_mileage is not none else '' }}</td>
        <td>{{ '%.2f'|format(t.fuel_used) if t.fuel_used is not none else '' }}</td>
        <td>{{ t.status }}</td>
        <td>
          <a class="btn btn-sm btn-primary" href="{{ url_for('tasks.edit_task', tid=t.id) }}">编辑</a>
          {% if not (current_user.role and '司机' in current_user.role) %}
            <form style="display:inline" method="post" action="{{ url_for('tasks.delete_task', tid=t.id) }}">
              <button class="btn btn-sm btn-danger" onclick="return confirm('确认删除?')">删除</button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="15" class="text-center">暂无任务</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}